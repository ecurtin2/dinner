version: '3.4'

services:
  server:
    image: evamicur/dinner-server:0.0.2
    build:
      context: .
    ports:
      - 9090:9090
    volumes:
      - ./server/data:/data
    environment:
      - RUST_LOG=info
      - DINNER_HOST=0.0.0.0:9090

  envoy:
    image: evamicur/dinner-envoy:0.0.2
    build:
      context: envoy
    ports:
      - "8080:8080"
      - "9901:9901"
    links:
      - server

# Don't actually use this right now but keep it around just in case
#  db:
#    build:
#      context: database
#    volumes:
#      - ./storage/postgres_data:/var/lib/postgresql/data/

  protobufs:
    build:
      context: protobufs
    volumes:
      - ./protobufs/recipe.proto:/recipe.proto
      - ./frontend/src/messages:/build/typescript

  frontend:
    depends_on:
      - envoy
      - server

    image: evamicur/dinner-frontend:0.0.2
    build:
      context: frontend
      target: prod
    ports:
      - 80:80

  frontend-dev:
    depends_on:
      - envoy
      - server
    build:
      context: frontend
      target: dev
    volumes:
      - ./frontend/src:/app/src
    ports:
      - 3001:3000